<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>룰렛 이벤트</title>
<style>
  body {
    font-family: sans-serif;
    text-align: center;
    background: #f9f9f9;
    padding: 20px;
  }
  #roulette-container {
    margin: 50px auto;
  }
  button {
    padding: 10px 20px;
    font-size: 16px;
    cursor: pointer;
  }
  #result {
    margin-top: 20px;
    font-size: 20px;
    font-weight: bold;
    color: #333;
  }
  #coupon {
    margin-top: 10px;
    font-size: 18px;
    color: #0044cc;
    word-break: break-all;
  }
</style>
</head>
<body>
<h1>룰렛 이벤트</h1>
<p>1등: 100권 시술권, 2등: 50만원 시술권, 3등: 1회 시술권, 4등: 최고급마스크팩</p>
<div id="roulette-container">
  <button id="spinBtn">룰렛 돌리기</button>
</div>
<div id="result"></div>
<div id="coupon"></div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
  // Firebase 초기화
  const firebaseConfig = {
    apiKey: "AIzaSyCe86NkQI1UaPK0pr0XqpvbBUBybTQkOQ0",
    authDomain: "count-3ce26.firebaseapp.com",
    projectId: "count-3ce26",
    storageBucket: "count-3ce26.appspot.com",
    messagingSenderId: "60996349215",
    appId: "1:60996349215:web:395dc0692334342670142a",
    measurementId: "G-2QFCDW8HNW"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // 사용자 식별을 위한 임시 userId (실 서비스에서는 로그인 기능 사용 권장)
  let userId = localStorage.getItem('userId');
  if (!userId) {
    userId = 'user_' + Math.random().toString(36).substring(2, 15);
    localStorage.setItem('userId', userId);
  }

  // 하루 1회 참여 제한을 위해 Firestore에 기록하는 함수
  async function hasPlayedToday() {
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth() + 1).padStart(2, '0');
    const dd = String(today.getDate()).padStart(2, '0');
    const dayKey = `${yyyy}-${mm}-${dd}`;

    const docRef = db.collection('roulette').doc(userId);
    const docSnap = await docRef.get();
    if (docSnap.exists) {
      const data = docSnap.data();
      if (data.lastPlay === dayKey) {
        return true;
      }
    }
    return false;
  }

  async function recordPlay(resultPrize, couponCode) {
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth() + 1).padStart(2, '0');
    const dd = String(today.getDate()).padStart(2, '0');
    const dayKey = `${yyyy}-${mm}-${dd}`;

    await db.collection('roulette').doc(userId).set({
      lastPlay: dayKey,
      prize: resultPrize,
      coupon: couponCode
    }, { merge: true });
  }

  function getRandomPrize() {
    // 1등: 100권 시술권
    // 2등: 50만원 시술권
    // 3등: 1회 시술권
    // 4등: 최고급마스크팩
    // 예: 1등: 5% 확률, 2등: 10% 확률, 3등: 30% 확률, 4등: 55% 확률 식으로 가중치 가능
    // 여기서는 단순히 4등분
    const random = Math.random();
    if (random < 0.05) {
      return "1등 (100권 시술권)";
    } else if (random < 0.15) {
      return "2등 (50만원 시술권)";
    } else if (random < 0.45) {
      return "3등 (1회 시술권)";
    } else {
      return "4등 (최고급마스크팩)";
    }
  }

  function generateCouponCode() {
    return 'COUPON-' + Math.random().toString(36).substring(2, 12).toUpperCase();
  }

  document.getElementById('spinBtn').addEventListener('click', async () => {
    const resultDiv = document.getElementById('result');
    const couponDiv = document.getElementById('coupon');
    resultDiv.textContent = '';
    couponDiv.textContent = '';

    // 하루 1회 참여여부 확인
    const playedToday = await hasPlayedToday();
    if (playedToday) {
      resultDiv.textContent = '오늘은 이미 참여하셨습니다. 내일 다시 참여해주세요!';
      return;
    }

    // 룰렛(난수) 돌리기
    const prize = getRandomPrize();
    const couponCode = generateCouponCode();

    // Firestore에 기록
    await recordPlay(prize, couponCode);

    resultDiv.textContent = `당첨! 축하합니다. 당신의 당첨 상품: ${prize}`;
    couponDiv.textContent = `당첨권 코드: ${couponCode}\n해당 코드를 샵에 방문하여 제시해주세요.`;
  });
</script>
</body>
</html>
