<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>윤석열 대통령 탄핵 국민투표</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            flex-direction: column;
        }

        .container {
            background: #fff;
            padding: 1em;
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            text-align: center;
            max-width: 500px;
            width: 90%;
            margin-bottom: 2em;
        }

        h1 {
            font-size: 1.4em;
            font-weight: 700;
            color: #333;
            margin-bottom: 1em;
        }

        .button-container {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1em;
        }

        .vote-btn {
            flex: 1;
            margin: 0 0.5em;
            font-size: 1em;
            padding: 0.7em 1em;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            color: #fff;
            font-weight: 600;
            box-sizing: border-box;
        }

        .agree-btn {
            background-color: #007aff;
        }

        .disagree-btn {
            background-color: #ff3b30;
        }

        .count-container {
            margin-top: 1em;
        }

        .count-label {
            display: inline-block;
            margin-right: 10px;
            font-size: 1em;
            font-weight: 600;
            color: #333;
        }

        .count-value {
            color: #333;
            font-weight: 700;
            font-size: 1.2em;
        }

        #voteChart {
            margin: 20px auto;
        }

        .timer {
            font-size: 1em;
            color: #555;
            margin-top: 10px;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>윤석열 대통령 탄핵 국민투표</h1>
        <div class="button-container">
            <button class="vote-btn agree-btn" id="agreeBtn">찬성</button>
            <button class="vote-btn disagree-btn" id="disagreeBtn">반대</button>
        </div>
        <div class="count-container">
            <span class="count-label">찬성:</span>
            <span class="count-value" id="agreeCount">Loading...</span>
            <br />
            <span class="count-label">반대:</span>
            <span class="count-value" id="disagreeCount">Loading...</span>
        </div>
        <canvas id="voteChart" width="400" height="200"></canvas>
        <p class="timer" id="timer">투표 종료까지 남은 시간: 계산 중...</p>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
        import { getFirestore, doc, getDoc, runTransaction } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCe86NkQI1UaPK0pr0XqpvbBUBybTQkOQ0",
            authDomain: "count-3ce26.firebaseapp.com",
            projectId: "count-3ce26",
            storageBucket: "count-3ce26.appspot.com",
            messagingSenderId: "60996349215",
            appId: "1:60996349215:web:395dc0692334342670142a",
            measurementId: "G-2QFCDW8HNW"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const pollRef = doc(db, "votes", "impeachmentPoll");

        const agreeCountElem = document.getElementById("agreeCount");
        const disagreeCountElem = document.getElementById("disagreeCount");
        const agreeBtn = document.getElementById("agreeBtn");
        const disagreeBtn = document.getElementById("disagreeBtn");
        const timerElem = document.getElementById("timer");

        const ctx = document.getElementById("voteChart").getContext("2d");
        const voteChart = new Chart(ctx, {
            type: "pie",
            data: {
                labels: ["찬성", "반대"],
                datasets: [{
                    data: [0, 0],
                    backgroundColor: ["#007aff", "#ff3b30"]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });

        async function loadCounts() {
            const docSnap = await getDoc(pollRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                agreeCountElem.textContent = data.agree;
                disagreeCountElem.textContent = data.disagree;
                updateChart(data);
            }
        }

        async function updateVote(field) {
            if (localStorage.getItem("hasVoted") === "true") {
                alert("이미 투표하셨습니다.");
                return;
            }

            try {
                await runTransaction(db, async (transaction) => {
                    const docSnap = await transaction.get(pollRef);
                    const data = docSnap.data();
                    data[field] += 1;
                    transaction.update(pollRef, data);
                });

                localStorage.setItem("hasVoted", "true");
                agreeBtn.disabled = true;
                disagreeBtn.disabled = true;
                loadCounts();
            } catch (error) {
                console.error("Error updating vote:", error);
                alert("투표 중 문제가 발생했습니다. 다시 시도해 주세요.");
            }
        }

        function updateChart(data) {
            voteChart.data.datasets[0].data = [data.agree, data.disagree];
            voteChart.update();
        }

        agreeBtn.addEventListener("click", () => updateVote("agree"));
        disagreeBtn.addEventListener("click", () => updateVote("disagree"));

        function startTimer() {
            const endTime = new Date("2024-12-25T23:59:59");
            setInterval(() => {
                const now = new Date();
                const remaining = endTime - now;

                if (remaining <= 0) {
                    agreeBtn.disabled = true;
                    disagreeBtn.disabled = true;
                    timerElem.textContent = "투표가 종료되었습니다.";
                    return;
                }

                const days = Math.floor(remaining / (1000 * 60 * 60 * 24));
                const hours = Math.floor((remaining % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((remaining % (1000 * 60)) / 1000);

                timerElem.textContent = `투표 종료까지 남은 시간: ${days}일 ${hours}시간 ${minutes}분 ${seconds}초`;
            }, 1000);
        }

        window.onload = () => {
            loadCounts();
            startTimer();
            if (localStorage.getItem("hasVoted") === "true") {
                agreeBtn.disabled = true;
                disagreeBtn.disabled = true;
            }
        };
    </script>
</body>

</html>
