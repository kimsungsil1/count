<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

    <title>윤석열 대통령 탄핵 국민투표</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            background: #fff;
            padding: 1em;
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            text-align: center;
            max-width: 320px;
            width: 90%;
        }

        h1 {
            font-size: 1.4em;
            font-weight: 700;
            color: #333;
            margin-bottom: 1em;
            line-height: 1.4;
        }

        .button-container {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1em;
        }

        .vote-btn {
            flex: 1;
            margin: 0 0.5em;
            font-size: 1em;
            padding: 0.7em 1em;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            color: #fff;
            font-weight: 600;
            box-sizing: border-box;
        }

        .vote-btn:active {
            transform: translateY(1px);
        }

        .agree-btn {
            background-color: #007aff;
        }

        .disagree-btn {
            background-color: #ff3b30;
        }

        .count-container {
            display: flex;
            justify-content: space-between;
            font-size: 1em;
            font-weight: 600;
            margin-top: 1em;
        }

        .count-item {
            flex: 1;
            text-align: center;
        }

        .count-label {
            display: block;
            margin-bottom: 0.5em;
            color: #333;
        }

        .count-value {
            color: #333;
            font-weight: 700;
            font-size: 1.2em;
        }

        /* 반응형 디자인 */
        @media (max-width: 400px) {
            h1 {
                font-size: 1.2em;
            }

            .vote-btn {
                font-size: 0.9em;
                padding: 0.5em 0.8em;
            }

            .count-label {
                font-size: 0.9em;
            }

            .count-value {
                font-size: 1.1em;
            }
        }

        .already-voted-msg {
            margin-top: 1em;
            color: #555;
            font-size: 0.9em;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>윤석열 대통령 탄핵 국민투표</h1>
        <div class="button-container">
            <button class="vote-btn agree-btn" id="agreeBtn">찬성</button>
            <button class="vote-btn disagree-btn" id="disagreeBtn">반대</button>
        </div>
        <div class="count-container">
            <div class="count-item">
                <span class="count-label">찬성:</span>
                <span class="count-value" id="agreeCount">Loading...</span>
            </div>
            <div class="count-item">
                <span class="count-label">반대:</span>
                <span class="count-value" id="disagreeCount">Loading...</span>
            </div>
        </div>
        <div class="already-voted-msg" id="alreadyVotedMsg" style="display:none;">
            이미 투표하셨습니다. 감사합니다.
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-analytics.js";
        import { getFirestore, doc, runTransaction } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID",
            measurementId: "YOUR_MEASUREMENT_ID"
        };

        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getFirestore(app);

        const agreeCountElem = document.getElementById('agreeCount');
        const disagreeCountElem = document.getElementById('disagreeCount');
        const agreeBtn = document.getElementById('agreeBtn');
        const disagreeBtn = document.getElementById('disagreeBtn');
        const alreadyVotedMsg = document.getElementById('alreadyVotedMsg');

        const pollRef = doc(db, 'votes', 'impeachmentPoll');

        async function loadCounts() {
            try {
                await runTransaction(db, async (transaction) => {
                    const docSnap = await transaction.get(pollRef);
                    if (!docSnap.exists()) {
                        transaction.set(pollRef, { agree: 0, disagree: 0 });
                        agreeCountElem.textContent = 0;
                        disagreeCountElem.textContent = 0;
                    } else {
                        const data = docSnap.data();
                        agreeCountElem.textContent = data.agree;
                        disagreeCountElem.textContent = data.disagree;
                    }
                });
            } catch (e) {
                console.error("Transaction failed: ", e);
                agreeCountElem.textContent = 'Error';
                disagreeCountElem.textContent = 'Error';
            }
        }

        async function updateAgree() {
            if (!canVote()) return;
            try {
                await runTransaction(db, async (transaction) => {
                    const docSnap = await transaction.get(pollRef);
                    if (!docSnap.exists()) {
                        transaction.set(pollRef, { agree: 1, disagree: 0 });
                        agreeCountElem.textContent = 1;
                    } else {
                        const newAgree = docSnap.data().agree + 1;
                        transaction.update(pollRef, { agree: newAgree });
                        agreeCountElem.textContent = newAgree;
                    }
                });
                afterVote();
            } catch (e) {
                console.error("Transaction failed: ", e);
            }
        }

        async function updateDisagree() {
            if (!canVote()) return;
            try {
                await runTransaction(db, async (transaction) => {
                    const docSnap = await transaction.get(pollRef);
                    if (!docSnap.exists()) {
                        transaction.set(pollRef, { agree: 0, disagree: 1 });
                        disagreeCountElem.textContent = 1;
                    } else {
                        const newDisagree = docSnap.data().disagree + 1;
                        transaction.update(pollRef, { disagree: newDisagree });
                        disagreeCountElem.textContent = newDisagree;
                    }
                });
                afterVote();
            } catch (e) {
                console.error("Transaction failed: ", e);
            }
        }

        // 투표 가능 여부 확인
        function canVote() {
            if (localStorage.getItem('hasVoted') === 'true') {
                return false;
            }
            return true;
        }

        // 투표 후 처리
        function afterVote() {
            localStorage.setItem('hasVoted', 'true');
            agreeBtn.disabled = true;
            disagreeBtn.disabled = true;
            alreadyVotedMsg.style.display = 'block';
        }

        // 페이지 로드 시 현재 투표 수 불러오기 및 투표 가능 여부 체크
        window.onload = function () {
            loadCounts();
            if (localStorage.getItem('hasVoted') === 'true') {
                agreeBtn.disabled = true;
                disagreeBtn.disabled = true;
                alreadyVotedMsg.style.display = 'block';
            }
        };

        agreeBtn.addEventListener('click', updateAgree);
        disagreeBtn.addEventListener('click', updateDisagree);
    </script>
</body>

</html>
